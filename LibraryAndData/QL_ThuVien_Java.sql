CREATE DATABASE QL_ThuVien_Java
USE QL_ThuVien_Java
CREATE TABLE TAIKHOAN
(
	TENDN NVARCHAR(30) NOT NULL,
	MATKHAU NVARCHAR(30) NOT NULL,
	EMAIL VARCHAR(30) NOT NULL,
	CONSTRAINT PK_TAIKHOAN PRIMARY KEY(TENDN)
)
CREATE TABLE THUTHU
(
	MATT CHAR(6) NOT NULL,
	HOTEN NVARCHAR(50),
	PHAI NVARCHAR(3),
	DIACHI NVARCHAR(50),
	SODT CHAR(10),
	TENDN NVARCHAR(30),
	QUYEN BIT,
	CONSTRAINT PK_THUTHU PRIMARY KEY(MATT),
	CONSTRAINT FK_THUTHU_TAIKHOAN FOREIGN KEY(TENDN) REFERENCES TAIKHOAN(TENDN)
)
CREATE TABLE THETV
(
	MATHE CHAR(6) NOT NULL,
	TENDG NVARCHAR(30),
	PHAI NVARCHAR(3),
	SODT CHAR(10),
	DIACHI NVARCHAR(30),
	NGAYCAP DATE,
	NGAYHETHAN DATE,
	CONSTRAINT PK_THETV PRIMARY KEY(MATHE)
)
CREATE TABLE THELOAI
(
	MALOAI CHAR(6) NOT NULL,
	TENLOAI NVARCHAR(50),
	CONSTRAINT PK_THELOAI PRIMARY KEY(MALOAI)
)
CREATE TABLE SACH
(
	MASH CHAR(6) NOT NULL,
	TENSH NVARCHAR(30),
	MALOAI CHAR(6),
	SOLUONG INT CHECK(SOLUONG >	 0),
	NXB NVARCHAR(30),
	NAMXB INT,
	TACGIA NVARCHAR(30),
	CONSTRAINT PK_SACH PRIMARY KEY(MASH),
	CONSTRAINT FK_SACH FOREIGN KEY(MALOAI) REFERENCES THELOAI(MALOAI)
)
CREATE TABLE MUONSACH
(
	MATHE CHAR(6) NOT NULL,
	MASH CHAR(6) NOT NULL,
	NGAYMUON DATE NOT NULL,
	MATT CHAR(6),
	NGAYTRA DATE,
	HANTRA DATE NOT NULL,
	TINHTRANG NVARCHAR(30),
	TIENPHAT MONEY DEFAULT 0,
	GHICHU NVARCHAR(MAX),
	CONSTRAINT PK_MUONSACH PRIMARY KEY(MATHE,MASH,NGAYMUON),
	CONSTRAINT FK_MUONSACH_THETV FOREIGN KEY(MATHE) REFERENCES THETV(MATHE),
	CONSTRAINT FK_MUONSACH_SACH FOREIGN KEY(MASH) REFERENCES SACH(MASH),
	CONSTRAINT FK_MUONSACH_THUTHU FOREIGN KEY(MATT) REFERENCES THUTHU(MATT)
)
---------------------------------------------------------------------------------

--Trigger không được mượn sách nếu số lượng sách này = 0 (hết sách)
GO
CREATE TRIGGER CK_SL_SACH
ON MUONSACH
FOR INSERT
AS
	IF((SELECT SOLUONG FROM SACH WHERE MASH = (SELECT MASH FROM inserted)) = 0)
	BEGIN
		PRINT N'Đã hết sách này'
		ROLLBACK TRAN
	END
--Treigger cập nhật số lượng sách khi 1 sách được mượn
GO
CREATE TRIGGER CN_SL_SACH_MUON
ON MUONSACH
FOR INSERT
AS
	BEGIN
		UPDATE SACH
		SET SOLUONG = SOLUONG - 1
		WHERE MASH = (SELECT MASH FROM inserted)

		UPDATE MUONSACH
		SET TINHTRANG = N'Đang mượn'
		WHERE MATHE = (SELECT MATHE FROM inserted) AND MASH = (SELECT MASH FROM inserted) AND NGAYMUON = (SELECT NGAYMUON FROM inserted)
	END
GO
GO
CREATE TRIGGER CN_SL_SACH_TRA
ON MUONSACH
FOR UPDATE
AS
	IF UPDATE(NGAYTRA)
	BEGIN
		UPDATE SACH
		SET SOLUONG = SOLUONG + 1
		WHERE MASH = (SELECT MASH FROM inserted)

		UPDATE MUONSACH
		SET TINHTRANG = N'Đã trả'
		WHERE MATHE = (SELECT MATHE FROM inserted) AND MASH = (SELECT MASH FROM inserted) AND NGAYMUON = (SELECT NGAYMUON FROM inserted)
	END
GO
GO
CREATE TRIGGER CN_SL_THAYDOI_MASH
ON MUONSACH
FOR UPDATE
AS
	IF UPDATE(MASH)
	BEGIN
		UPDATE SACH
		SET SOLUONG = SOLUONG - 1
		WHERE MASH = (SELECT MASH FROM inserted)

		UPDATE SACH
		SET SOLUONG = SOLUONG + 1
		WHERE MASH = (SELECT MASH FROM deleted)
	END
GO

CREATE TRIGGER CN_SL_SACH_XOA
ON MUONSACH
FOR DELETE
AS
	UPDATE SACH
	SET SOLUONG = SOLUONG + 1
	WHERE MASH = (SELECT MASH FROM deleted)
GO

CREATE TRIGGER CK_HANTHE
ON MUONSACH
FOR INSERT
AS
	IF ((SELECT NGAYHETHAN FROM THETV WHERE MATHE = (SELECT MATHE FROM inserted)) < GETDATE())
	BEGIN
		PRINT N'Thẻ đã hết hạn'
		ROLLBACK TRAN
	END
GO
CREATE TRIGGER CK_HANTHE_THAYDOI_MATHE
ON MUONSACH
FOR UPDATE
AS
	IF UPDATE(MATHE)
	BEGIN
		IF ((SELECT NGAYHETHAN FROM THETV WHERE MATHE = (SELECT MATHE FROM inserted)) < GETDATE())
		BEGIN
			PRINT N'Thẻ đã hết hạn'
			ROLLBACK TRAN
		END
	END

--------------------------------------------------------------------------------

SELECT * FROM THUTHU
SELECT * FROM MUONSACH
SELECT * FROM THETV
SELECT * FROM SACH
SELECT * FROM THELOAI
	
--Nhập 3 tài khoản --Tương ứng với 3 Thủ thư
INSERT INTO TAIKHOAN VALUES(N'hongson294',N'son123','sonpham.031195@gmail.com');
INSERT INTO TAIKHOAN VALUES(N'vinhkiet00',N'kiet123','kietlam.25122015@gmail.com');
INSERT INTO TAIKHOAN VALUES(N'ngoclong30',N'long123','kietlam.25122015@gmail.com');
INSERT INTO TAIKHOAN VALUES(N'thanhvy',N'thanhvy123','thanhvyela@gmail.com');
SELECT * FROM TAIKHOAN;
INSERT INTO THUTHU VALUES('TT0001',N'Phạm Hồng Sơn',N'Nam',N'TP HCM','0988740615','hongson294',1);
INSERT INTO THUTHU VALUES('TT0002',N'Lâm Vĩnh Kiệt',N'Nam',N'TP HCM','0913170156','vinhkiet00',1);
INSERT INTO THUTHU VALUES('TT0003',N'Tô Ngọc Long',N'Nam',N'TP HCM','0124896000','ngoclong30',1);
INSERT INTO THUTHU VALUES('TT0004',N'Nguyễn Đức Thanh Vy',N'Nữ',N'TP HCM','0124896000','thanhvy',1);
SELECT * FROM THUTHU;
--------------------------------------THETV-------------------------------------------
--Nhập ngày hết hạn 6 tháng kể từ ngày cấp
-- 7 dòng còn hạn.
--3 dòng hêt hạn(3 dòng cuối).
SET DATEFORMAT DMY;
INSERT INTO THETV  VALUES('TH0001',N'Trần Thế Kiệt',N'Nam','1234567890',N'Đồng Nai','01/05/2020','01/11/2020');
INSERT INTO THETV  VALUES('TH0002',N'Nguyễn Linh Trang',N'Nữ','0997784560',N'Cà Mau','10/04/2020','10/10/2020');
INSERT INTO THETV  VALUES('TH0003',N'Nguyễn Anh Tuấn',N'Nam','0966288828',N'Cà Mau','15/03/2020','15/09/2020');
INSERT INTO THETV  VALUES('TH0004',N'Phan Thanh Trang',N'Nữ','0112283928',N'Cà Mau','15/03/2020','15/09/2020');
INSERT INTO THETV  VALUES('TH0005',N'Nguyễn Phương Vy',N'Nữ','0998773668',N'Tp HCM','13/07/2020','13/01/2021');
INSERT INTO THETV  VALUES('TH0006',N'Lê Văn Phúc',N'Nam','0229986528',N'Bạc Liêu','02/03/2020','02/09/2020');
INSERT INTO THETV  VALUES('TH0007',N'Cao Hoàng Phúc',N'Nam','0928287728',N'Vũng Tàu','06/08/2019','06/02/2020');
INSERT INTO THETV  VALUES('TH0008',N'Nguyễn Hùng Dũng',N'Nam','0918283828',N'Đồng Nai','02/06/2020','02/11/2020');
INSERT INTO THETV  VALUES('TH0009',N'Lê Thúy Vi',N'Nữ','0998285358',N'Phú Quốc','10/02/2019','10/08/2020');
INSERT INTO THETV  VALUES('TH0010',N'Nguyễn Hùng Dũng',N'Nam','0918283828',N'Đồng Nai','20/01/2020','20/07/2020');
INSERT INTO THETV  VALUES('TH0011',N'Nguyễn Diệu Linh',N'Nữ','0918283853',N'Đà Nẵng','20/01/2019','20/07/2019');
SELECT * FROM THETV;
--Thẻ hết hạn 7,10,11
---------------------------------------------------------------------------------
--Thể loại 15 dòng
INSERT INTO THELOAI VALUES('L00001',N'Truyện');
INSERT INTO THELOAI VALUES('L00002',N'Chính trị');
INSERT INTO THELOAI VALUES('L00003',N'Văn học');
INSERT INTO THELOAI VALUES('L00004',N'Khoa học');
INSERT INTO THELOAI VALUES('L00005',N'Chuyên ngành');
INSERT INTO THELOAI VALUES('L00006',N'Kinh dị');
INSERT INTO THELOAI VALUES('L00007',N'Tiểu thuyết');
INSERT INTO THELOAI VALUES('L00008',N'Lịch sử');
INSERT INTO THELOAI VALUES('L00009',N'Tôn giáo');
INSERT INTO THELOAI VALUES('L00010',N'Tâm lý học');
INSERT INTO THELOAI VALUES('L00011',N'Ngoại ngữ');
INSERT INTO THELOAI VALUES('L00012',N'Trinh thám');
INSERT INTO THELOAI VALUES('L00013',N'Thơ ca');
INSERT INTO THELOAI VALUES('L00014',N'Kinh tế');
INSERT INTO THELOAI VALUES('L00015',N'Pháp luật');
SELECT * FROM THELOAI;
---------------------------------------------------------------------------------
--Nhập 20 dòng sách
INSERT INTO SACH VALUES('SH0001',N'Doraemon','L00001',20,N'Kim Đồng',2010,N'Fujiko');
INSERT INTO SACH VALUES('SH0002',N'Mac-Lênin','L00002',12,N'Chính trị Quốc Gia',2012,N'Nguyễn Tuấn Tú');
INSERT INTO SACH VALUES('SH0003',N'Lập trình C','L00005',24,N'Thông Tin và Truyền Thông',2015,N'Lê Hoàng Sang');
INSERT INTO SACH VALUES('SH0004',N'Truyện Kiều','L00003',20,N'Văn Học',2013,N'Nguyễn Du');
INSERT INTO SACH VALUES('SH0005',N'Lập trình C#','L00005',5,N'Thanh Niên',2010,N'Lê Hoàng Sang');
INSERT INTO SACH VALUES('SH0006',N'7 viên ngọc rồng','L00001',30,N'Kim Đồng',1984,N'Toriyama Akira');
INSERT INTO SACH VALUES('SH0007',N'Kỳ án ánh trăng','L00006',1,N'Văn Học',2015,N'Quỷ Cổ Nữ');
INSERT INTO SACH VALUES('SH0008',N'666 Câu đố Việt Nam','L00013',5,N'Hồng Đức',2018,N'Mai Chi');
INSERT INTO SACH VALUES('SH0009',N'Bách khoa lịch sử thế giới','L00008',2,N'Dân Trí',2018,N'Sam Taplin');
INSERT INTO SACH VALUES('SH0010',N'Triết học luật pháp','L00015',1,N'Tri Thức',2018,N'Raymond Wacks');
INSERT INTO SACH VALUES('SH0011',N'The Selfish Gene (Gene vị kỷ)','L00004',1,N'Tri Thức',2019,N'Richard Dawkins');
INSERT INTO SACH VALUES('SH0012',N'Hỗn độn và hài hòa','L00004',6,N'Tuổi Trẻ',2018,N'Trịnh Xuân Thuận');
INSERT INTO SACH VALUES('SH0013',N'Rồng Đỏ','L00007',11,N'Hội Nhà Văn',2018,N'Thomas Harris');
INSERT INTO SACH VALUES('SH0014',N'Chiến tranh tiền tệ','L00014',5,N'Lao Động',2020,N'Song Hong Bing');
INSERT INTO SACH VALUES('SH0015',N'Sự im lặng của bầy cừu','L00012',10,N'Hội Nhà Văn',1998,N'Thomas Harris');
INSERT INTO SACH VALUES('SH0016',N'Kinh Đại Bát Nhã Ba La Mật Đa','L00009',15,N'Hồng Đức',2018,N'Thích Trí Nghiêm');
INSERT INTO SACH VALUES('SH0017',N'Văn học trung đại Việt Nam','L00003',20,N'ĐH Sư Phạm',2014,N'Đinh Thị Khang');
INSERT INTO SACH VALUES('SH0018',N'Ngữ pháp Tiếng Anh căn bản','L00011',5,N'ĐHQG Hà Nội',2019,N'Bùi Ngọc Mai');
INSERT INTO SACH VALUES('SH0019',N'100 bài luận mẫu Tiếng Anh','L00011',5,N'Dân Trí',2018,N'Mỹ Duy');
INSERT INTO SACH VALUES('SH0020',N'Tâm lý học và đời sống','L00010',17,N'Hồng Đức',2018,N'G. Zimbardo');
SELECT * FROM SACH;

SELECT * FROM MUONSACH
---------------------------------------------------------------------------------
SET DATEFORMAT DMY;
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0008','SH0002','TT0001','20/01/2020','30/01/2020','05/02/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0003','SH0001','TT0001','20/01/2020','30/01/2020','05/02/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0003','SH0001','TT0003','05/02/2020',NULL,'16/02/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0004','SH0005','TT0003','02/02/2020',NULL,'16/02/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0002','SH0004','TT0002','06/02/2020',NULL,'16/02/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0008','SH0001','TT0002','10/02/2020','12/02/2020','25/02/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0009','SH0016','TT0002','22/02/2020','26/02/2020','07/03/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0008','SH0017','TT0001','22/02/2020','23/02/2020','07/03/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0004','SH0018','TT0002','22/02/2020','28/02/2020','07/03/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0001','SH0005','TT0002','02/02/2020','10/02/2020','17/02/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0008','SH0009','TT0003','03/02/2020',NULL,'18/02/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0002','SH0008','TT0002','02/03/2020','09/03/2020','17/03/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0009','SH0007','TT0002','02/04/2020','07/04/2020','17/04/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0005','SH0003','TT0002','29/04/2020','02/05/2020','14/05/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0005','SH0004','TT0002','29/04/2020','30/04/2020','14/05/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0001','SH0001','TT0002','01/04/2020',NULL,'16/04/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0003','SH0012','TT0001','04/04/2020',NULL,'19/04/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0005','SH0011','TT0002','04/04/2020',NULL,'19/04/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0009','SH0001','TT0003','02/05/2020','07/05/2020','17/05/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0009','SH0002','TT0002','02/05/2020','05/05/2020','17/05/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0003','SH0015','TT0003','29/05/2020','30/06/2020','16/05/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0004','SH0006','TT0003','28/06/2020','02/07/2020','13/07/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0003','SH0007','TT0003','28/06/2020','05/07/2020','13/07/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0002','SH0009','TT0001','08/06/2020','15/06/2020','23/06/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0002','SH0010','TT0001','08/06/2020','18/06/2020','23/06/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0003','SH0008','TT0003','07/06/2020','08/06/2020','22/06/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0001','SH0011','TT0001','01/06/2020','05/06/2020','16/06/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0001','SH0012','TT0001','01/06/2020','13/06/2020','16/06/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0009','SH0005','TT0001','01/06/2020',NULL,'16/06/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0006','SH0013','TT0001','01/07/2020','13/07/2020','16/07/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0006','SH0014','TT0002','01/07/2020','03/07/2020','16/07/2020',NULL);

INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0002','SH0001','TT0001','02/08/2020',NULL,'17/08/2020',NULL);
INSERT INTO MUONSACH(MATHE,MASH,MATT,NGAYMUON,NGAYTRA,HANTRA,GHICHU) VALUES
('TH0008','SH0008','TT0002','03/08/2020',NULL,'18/08/2020',NULL);
--




delete from MUONSACH

UPDATE MUONSACH
SET TINHTRANG = N'Đã trả'
WHERE NGAYTRA IS NOT NULL

UPDATE MUONSACH
SET TINHTRANG = N'Đang mượn'
WHERE NGAYTRA IS NULL


SELECT * FROM MUONSACH
SELECT * FROM THETV
SELECT * FROM THUTHU
SELECT * FROM TAIKHOAN
SELECT * FROM SACH
SELECT * FROM THELOAI

---------------------------------------------------------------------------------
